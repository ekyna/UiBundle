define(["require","jquery","bootstrap/dialog","ekyna-polyfill"],function(t,d,o){"use strict";function e(){this.dialog=new o,this.form=null,this.shown=!1;var e=this,n=d(this);this.dialog.onShow(function(){var t=d.Event("ekyna.modal.show");t.modal=e,n.trigger(t),e.dialog.getModalBody().on("click",i,function(t){return t.preventDefault(),t.stopPropagation(),e.load({url:d(t.currentTarget).attr("href")}),!1})}),this.dialog.onShown(function(){e.shown=!0;var t=d.Event("ekyna.modal.shown");t.modal=e,n.trigger(t)}),this.dialog.onHide(function(){e.shown=!1;var t=d.Event("ekyna.modal.hide");if(t.modal=e,n.trigger(t),t.isDefaultPrevented())return!1;e.form&&(e.form.destroy(),e.form=null)}),this.dialog.onHidden(function(){var t=d.Event("ekyna.modal.hidden");t.modal=e,n.trigger(t)})}var i="button[data-modal], a[data-modal], [data-modal] > a";return e.prototype={constructor:e,load:function(t){t.cache=!1;var o=this,t=d.ajax(t);return t.done(function(t,e,n){o.handleResponse(t,e,n)}),t.fail(function(){console.log("Failed to load modal.");var t=d.Event("ekyna.modal.load_fail");d(o).trigger(t)}),t},initForm:function(n){var i=this;d(this.dialog.getModal()).removeAttr("tabindex"),t(["ekyna-form"],function(t){i.form=t.create(n),i.form.init(i.dialog.getModal());function e(t){var e,n,o=i.form.getElement().get(0);o.reportValidity&&!o.reportValidity()||o.hasOwnProperty("_submitted")&&o._submitted||(o._submitted=!0,e=i.form.getElement(),n={},i.dialog.enableButtons(!1),1===(t=t||e.find("button[type=submit]").eq(0)).length?(t.find("span, i").removeClass().addClass("glyphicon glyphicon-asterisk icon-spin"),t.attr("name")&&t.attr("value")&&(n[t.attr("name")]=t.attr("value"))):(t=i.dialog.getButton("submit"))&&t.toggleSpin(!0),e.find("button").prop("disabled",!0),i.form.save(),setTimeout(function(){i.form.getElement().ajaxSubmit({data:n,success:function(t,e,n){i.handleResponse(t,e,n)},error:function(){o._submitted=!1}})},100))}i.form.getElement().on("keyup","input, select",function(t){if(13===(t.keyCode||t.which))return t.preventDefault(),t.stopPropagation(),e(),!1}).on("mouseup","button[type=submit]",function(t){return t.preventDefault(),t.stopPropagation(),e(d(t.target)),!1}).on("submit",function(t){return t.preventDefault(),t.stopPropagation(),e(),!1})})},getContentType:function(t){var e="html",n=t.getResponseHeader("Content-Type");return null===n&&t.getResponseHeader("content-type"),/json/.test(n)?e="json":/xml/.test(n)&&(e="xml"),e},handleResponse:function(t,e,n){var o=this,i=d(this),r=this.getContentType(n);function a(t){return t.hasOwnProperty("load_url")&&t.load_url?(o.load({url:t.load_url,method:"GET"}),1):t.hasOwnProperty("redirect_url")&&t.redirect_url&&(window.location.href=t.redirect_url,1)}if(this.submitButton=null,this.form&&(this.form.destroy(),this.form=null),(l=d.Event("ekyna.modal.response")).modal=this,l.contentType=r,l.content=t,l.jqXHR=n,i.trigger(l),l.isDefaultPrevented())return this;if("json"===r&&a(l.content))return this;if("xml"!==r)return this;n=d(t),t=n.find("content");if(!(0<t.length))return this;r=t.attr("type"),(l=d.Event("ekyna.modal.content")).modal=this,l.contentType=r;t=t.text();if("data"===r)return l.content=JSON.parse(t),i.trigger(l),l.isDefaultPrevented()||a(l.content)?this:this.close();r=d(t);if(l.content=r,i.trigger(l),l.isDefaultPrevented())return this.close();this.dialog.setMessage(r);var s=r.is("form.modal-form")?r:r.find("form.modal-form:first"),t=(1===s.length&&(o.shown?o.initForm(s):i.one("ekyna.modal.shown",function(){o.initForm(s)})),i.trigger(d.Event("ekyna.modal.updated")),n.find("title")),l=(1===t.length&&this.dialog.setTitle(t.text()),n.find("buttons")),t=(1===l.length?(r=JSON.parse(l.text(),function(t,e){return e&&"string"==typeof e&&0===e.indexOf("function")?new Function("return "+e)():e}),d(r).each(function(t,n){"function"!=typeof n.action&&("close"===n.id?n.action=function(t){t.enableButtons(!1),t.close()}:n.action=function(t){var e=d.Event("ekyna.modal.button_click");e.modal=o,e.buttonId=n.id,i.trigger(e),e.isDefaultPrevented()||"submit"===n.id&&(o.form?o.form.getElement().trigger("submit"):t.enableButtons(!1))})}),this.dialog.setButtons(r)):this.dialog.setButtons([]),JSON.parse(n.find("config").text()));return void 0!==t.type&&this.dialog.setType(t.type),void 0!==t.size&&this.dialog.setSize(t.size),void 0!==t.cssClass&&this.dialog.setCssClass(t.cssClass),this.dialog.isOpened()||this.dialog.open(),void 0!==t.condensed&&(t.condensed?this.dialog.getModal().addClass("condensed"):this.dialog.getModal().removeClass("condensed")),this},close:function(){return this.dialog.isOpened()&&this.dialog.close(),this},getDialog:function(){return this.dialog}},d(document).on("click",i,function(t){return t.preventDefault(),(new e).load({url:d(t.currentTarget).attr("href")}),!1}),e});