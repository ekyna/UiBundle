define(["jquery","ekyna-modal","ekyna-table","select2"],function(i,l,c){"use strict";return i.fn.entityWidget=function(){return this.each(function(){let e=i(this),t=e.find("button.new-resource"),n=e.find("button.list-resource"),o=e.find("select");1===t.length&&t.on("click",function(){let e=new l;e.load({url:t.data("path")}),i(e).on("ekyna.modal.response",function(n){if("json"===n.contentType){n.preventDefault();let e=n.content,t=i("<option />");if(e=e[e.resource],t.prop("value",e.id),t.prop("selected",!0),void 0!==e.choice_label)t.html(e.choice_label);else if(void 0!==e.text)t.html(e.text);else{if(void 0===e.title)throw"Unexpected resource data.";t.html(e.title)}o.find("option").prop("selected",!1),o.append(t).trigger("change"),n.modal.close()}})}),1===n.length&&n.on("click",function(){let t=new l;t.load({url:n.data("path")}),i(t).on("ekyna.modal.content",function(e){if("table"!==e.contentType)throw"Expected modal content type = 'table'.";c.create(e.content,{ajax:!0,onSelection:function(e){o.prop("multiple")&&o.find("option").prop("selected",!1),i(e).each(function(e,t){let n=o.find("option[value="+t.id+"]");1===n.length?n.prop("selected",!0):((n=i("<option />")).prop("value",t.id),n.prop("selected",!0),void 0!==t.choice_label?n.html(t.choice_label):void 0!==t.text?n.html(t.text):void 0!==t.title?n.html(t.title):n.html("Entity #"+t.id),o.append(n))}),o.trigger("change"),t.getDialog().close()}})})})}),this},{init:function(e){e.entityWidget()}}});