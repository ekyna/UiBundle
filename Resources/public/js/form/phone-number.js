define(["jquery","ekyna-flags","ekyna-string"],function(s,t){"use strict";t.load();function i(t){this.$form=s(t),this.$country=this.$form.find("#"+this.$form.attr("id")+"_country"),this.$number=this.$form.find("#"+this.$form.attr("id")+"_number"),this.$dropdown=this.$form.find(".dropdown"),this.$flag=this.$dropdown.find("button > .country-flag"),this.$dial=this.$dropdown.find("button > .country-dial"),this.$list=null,this.$current=null,this.$watch=null,this.spellString="",this.spellTimeout=null}var e=s.getJSON("/js/countries.json?locale="+s("html").attr("lang"));return i.prototype.init=function(){var i=this;e.then(function(t){i.buildList(t)}),this.onListClick=s.proxy(this.listClickHandler,this),this.onListKeydown=s.proxy(this.listKeydownHandler,this),this.onSpellTimeout=s.proxy(function(){this.spellString="",this.spellTimeout=null},this)},i.prototype.buildList=function(t){var i=document.createElement("div"),r=document.createElement("ul");this.$dropdown.find("> .dropdown-menu").empty().append(i),i.appendChild(r),s.each(t,function(t,i){var e=document.createElement("li"),n=document.createElement("span"),s=document.createElement("span"),o=document.createElement("span");e.setAttribute("data-name",i.name.removeDiatrics().toLowerCase().replace(/[^a-z]+/," ")),e.setAttribute("data-code",t),e.setAttribute("data-dial",i.dial),e.setAttribute("data-fixed",i.fixed),e.setAttribute("data-mobile",i.mobile),n.classList.add("country-flag",t.toLowerCase()),e.appendChild(n),s.classList.add("country-name"),s.innerText=i.name,e.appendChild(s),0<i.dial&&(o.classList.add("country-dial"),o.innerText="+"+i.dial,e.appendChild(o)),r.appendChild(e)}),this.$list=s(i),this.selectCountry(this.$dropdown.find('li[data-code="'+this.$country.val()+'"]')),this.$dropdown.on("show.bs.dropdown",s.proxy(this.enableListHandlers,this)),this.$dropdown.on("hide.bs.dropdown",s.proxy(this.disableListHandlers,this)),this.$dropdown.on("shown.bs.dropdown",s.proxy(this.scrollToSelected,this)),this.$country.on("change",s.proxy(this.countryChangeHandler,this)),this.$form.data("watch")&&(this.$watch=s("#"+this.$form.data("watch")),this.$watch.length&&(this.$watch.on("change",s.proxy(this.watchChangeHandler,this)),this.watchChangeHandler()))},i.prototype.enableListHandlers=function(){this.$dropdown.on("click","li",this.onListClick),this.$dropdown.on("keydown",this.onListKeydown)},i.prototype.disableListHandlers=function(){this.$dropdown.off("click","li",this.onListClick),this.$dropdown.off("keydown",this.onListKeydown)},i.prototype.countryChangeHandler=function(){this.$country.val()&&this.selectCountry(this.$dropdown.find('li[data-code="'+this.$country.val()+'"]'))},i.prototype.watchChangeHandler=function(){this.$number.val()||this.selectCountry(this.$dropdown.find('li[data-code="'+this.$watch.val()+'"]'))},i.prototype.listClickHandler=function(t){this.selectCountry(s(t.currentTarget))},i.prototype.listKeydownHandler=function(t){38!==t.which?40!==t.which?(65<=t.which&&t.which<=90||97<=t.which&&t.which<=122)&&this.spellSelect(String.fromCharCode(t.which)):this.selectNext():this.selectPrevious()},i.prototype.selectPrevious=function(){var t;0!==this.$current.length?(t=this.$current.prev()).length?this.selectCountry(t):this.selectCountry(this.$dropdown.find("li:last-child")):this.selectCountry(this.$dropdown.find("li:first-child"))},i.prototype.selectNext=function(){var t;0!==this.$current.length&&(t=this.$current.next()).length?this.selectCountry(t):this.selectCountry(this.$dropdown.find("li:first-child"))},i.prototype.spellSelect=function(t){this.spellTimeout&&clearTimeout(this.spellTimeout),this.spellString+=t;var e,n=new RegExp("^"+this.spellString,"i");this.$dropdown.find("li").each(function(t,i){if(n.test(i.getAttribute("data-name")))return e=s(i),!1}),this.spellTimeout=setTimeout(this.onSpellTimeout,500),e&&this.selectCountry(e)},i.prototype.selectCountry=function(t){0!==t.length&&this.$current!==t&&(this.$current&&(this.$current.removeClass("active"),this.$flag.removeClass(String(this.$current.data("code")).toLowerCase()),this.$dial.empty(),this.$current=null),this.$current=t,this.$current.addClass("active"),(t=String(this.$current.data("code")))!==this.$country.val()&&this.$country.val(t),this.$flag.addClass(t.toLowerCase()),this.$dial.text("+"+this.$current.data("dial")),this.$number.removeAttr("placeholder"),(t=this.$current.data(this.$form.data("type")))&&this.$number.attr("placeholder",t),this.scrollToSelected())},i.prototype.scrollToSelected=function(){this.$current&&this.$current.length&&this.$list.scrollTop(this.$current.position().top+this.$list.scrollTop())},s.fn.phoneNumberWidget=function(){return this.each(function(){new i(this).init()})},{init:function(t){t.phoneNumberWidget()}}});