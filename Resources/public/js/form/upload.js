define(["jquery","jquery/fileupload","jquery/qtip","ekyna-form/file-picker","ekyna-string"],function(i){"use strict";function e(t,e){t.data("RenameWidget",this),e=i.extend({file:null},e),this.$element=t,this.$file=e.file,this.extension="",this.defaultValue=this.$element.val(),this.getExtension(),this.$file&&1===this.$file.length&&(this.$file.on("change",i.proxy(this.updateFromFile,this)),this.updateFromFile()),this.$element.on("focus",i.proxy(this.stripExtension,this)),this.$element.on("blur",i.proxy(this.normalize,this))}function t(t){t.data("UploadWidget",this),this.$element=t,this.$picker=this.$element.find(".file-picker"),this.$file=this.$picker.find("input:file"),this.$rename=this.$element.find(".file-rename").renameWidget({file:this.$file}),this.$key=this.$element.find('input[data-target="'+this.$file.attr("id")+'"]'),0!==this.$key.length&&(this.$form=this.$file.closest("form"),this.$progressBar=this.$element.find("div#"+this.$file.attr("id")+"_progress"),this.$submitButton=this.$form.find("[type=submit]"),this.uploadXhr=null,this.init())}return e.prototype.getExtension=function(){var t=this.$element.val().fileExtension();0<t.length&&(this.extension="."+t),this.normalize()},e.prototype.stripExtension=function(){var t;0===this.extension.length||0<(t=this.$element.val().lastIndexOf(this.extension))&&this.$element.val(this.$element.val().substring(0,t))},e.prototype.appendExtension=function(){this.$element.val(this.$element.val()+this.extension)},e.prototype.normalize=function(){this.stripExtension();var t=this.$element.val().trim().toLowerCase().urlize();0<t.length?(this.$element.val(t),this.appendExtension()):this.$element.val(this.defaultValue)},e.prototype.updateFromFile=function(){0!==this.$file.length&&this.setFilename(this.$file.val())},e.prototype.setFilename=function(t){0<t.length?(0===this.$element.val().length&&this.$element.val(t.fileName()),0<(t=t.fileName().fileExtension()).length?(this.stripExtension(),this.extension="."+t,this.normalize()):this.getExtension()):(this.$element.val(this.defaultValue),this.getExtension())},i.fn.renameWidget=function(t){return this.each(function(){void 0===i(this).data("RenameWidget")&&new e(i(this),t)}),this},t.prototype.init=function(){this.$file.fileupload({replaceFileInput:!1}),this.$file.on("fileuploadadd",i.proxy(this.onUploadAdd,this)),this.$file.on("fileuploadsubmit",i.proxy(this.onUploadSubmit,this)),this.$file.on("fileuploadalways",i.proxy(this.onUploadAlways,this)),this.$file.on("fileuploaddone",i.proxy(this.onUploadDone,this)),this.$file.on("fileuploadprogress",i.proxy(this.onUploadProgress,this)),this.$picker.on("ekyna.upload.clear",i.proxy(this.onPickerClear,this)),this.$form.on("submit",i.proxy(this.onFormSubmit,this))},t.prototype.onUploadAdd=function(t,e){this.uploadXhr&&this.uploadXhr.abort(),console.log("uploadAdd",e);var i=e.originalFiles[0].name,n=this.$picker.data("FilePicker"),s=this.$rename.data("RenameWidget");n.clear(),n.$text.val(i).trigger("change"),s.setFilename(i),this.uploadXhr=e.submit()},t.prototype.onUploadSubmit=function(){var t=this.$form.data("uploadCount")||0;t++,this.$submitButton.prop("disabled",!0),this.$form.data("uploadCount",t),this.$progressBar.fadeIn()},t.prototype.onUploadAlways=function(){var t=this.$form.data("uploadCount")||0;this.$form.data("uploadCount",--t),t<=0&&this.$submitButton.prop("disabled",!1),this.$progressBar.fadeOut(function(){i(this).find(".progress-bar").css({width:"0%"}).attr("aria-valuenow",0)}),this.uploadXhr=null},t.prototype.onUploadDone=function(t,e){e=JSON.parse(e.result);e.hasOwnProperty("upload_key")&&this.$key.val(e.upload_key)},t.prototype.onUploadProgress=function(t,e){e._progress&&(e=parseInt(e._progress.loaded/e._progress.total*100,10),this.$progressBar.find(".progress-bar").css({width:e+"%"}).attr("aria-valuenow",e))},t.prototype.onPickerClear=function(){this.$key.val(null),this.uploadXhr&&(this.uploadXhr.abort(),this.uploadXhr=null)},t.prototype.onFormSubmit=function(t){return(this.$form.data("uploadCount")||0)<=0||(this.$submitButton.qtip({content:"Veuillez patienter pendant le téléchargement de vos fichiers&hellip;",style:{classes:"qtip-bootstrap"},hide:{fixed:!0,delay:300},position:{my:"bottom center",at:"top center",target:"mouse",adjust:{mouse:!1,scroll:!1}}}),t.preventDefault(),!1)},i.fn.uploadWidget=function(){return this.each(function(){void 0===i(this).data("UploadWidget")&&new t(i(this))}),this},{init:function(t){t.uploadWidget()}}});