define(["jquery","ekyna-form"],function(l,c){"use strict";function n(e){l(e).on("click",t,this.addField)}function o(e){l(e).on("click",i,this.removeField)}function d(e){l(e).on("click",r,this.moveUpField)}function a(e){l(e).on("click",f,this.moveDownField)}var t='[data-collection-role="add"]',i='[data-collection-role="remove"]',r='[data-collection-role="move-up"]',f='[data-collection-role="move-down"]';function v(e){var i='[data-collection="'+e.attr("id")+'"]',e=e.find(".ekyna-collection-child-container").first().find("> .ekyna-collection-child"),n=e.length-1;e.each(function(e,t){t=l(t);t.find(i+'[data-collection-role="position"]').first().val(e),0===e?t.find(i+r).prop("disabled",!0):t.find(i+r).prop("disabled",!1),e===n?t.find(i+f).prop("disabled",!0):t.find(i+f).prop("disabled",!1)})}n.prototype.addField=function(e){e&&e.preventDefault();var i,e=l(this),t=e.attr("data-collection"),t=l("#"+t),n=t.find(".ekyna-collection-child-container").first(),e=e.attr("data-prototype-name"),o=l("#"+t.attr("data-prototype")).text(),d=t.data("child-index"),a=(void 0===d&&(d=-1,i=new RegExp(o.match(/id="(.*?)"/)[1].replace(e,"(\\d+)")),n.find("> .ekyna-collection-child").each(function(e,t){t=parseInt(l(t).attr("id").match(i)[1]);d<t&&(d=t)})),d++,t.data("child-index",d),o.match(/id="(.*?)"/)),e=new RegExp(e,"g"),a=(o=(o=o.replace(e,d)).replace(/__id__/g,a[1].replace(e,d)),l(o));n.append(a);c.create(a).init(),v(t);e=l.Event("ekyna-collection-field-added");e.target=a,t.trigger(e)},o.prototype.removeField=function(e){var t=l(this),i=t.attr("data-collection");e&&e.preventDefault(),t.data("confirm")&&!confirm(t.data("confirm"))||(e=t.closest(".ekyna-collection-child"),(t=c.create(e)).save(),t.destroy(),e.remove(),v(t=l("#"+i)),(i=l.Event("ekyna-collection-field-removed")).target=e,t.trigger(i))},d.prototype.moveUpField=function(e){var t,i,n=l(this),o=n.attr("data-collection"),e=(e&&e.preventDefault(),n.closest(".ekyna-collection-child"));e.is(":first-child")||(n=e.prev(),(t=c.create(e)).save(),t.destroy(),(i=c.create(n)).save(),i.destroy(),n.before(e.detach()),t.init(e),i.init(n),v(t=l("#"+o)),(i=l.Event("ekyna-collection-field-moved-up")).target=e,t.trigger(i))},a.prototype.moveDownField=function(e){var t,i,n=l(this),o=n.attr("data-collection"),e=(e&&e.preventDefault(),n.trigger("ekyna-collection-field-moved-down"),n.closest(".ekyna-collection-child"));e.is(":last-child")||(n=e.next(),(t=c.create(e)).save(),t.destroy(),(i=c.create(n)).save(),i.destroy(),n.after(e.detach()),t.init(e),i.init(n),v(t=l("#"+o)),(i=l.Event("ekyna-collection-field-moved-down")).target=e,t.trigger(i))};var e=l.fn.addField,p=l.fn.removeField,s=l.fn.moveUpField,u=l.fn.moveDownField;return l.fn.addField=function(i){return this.each(function(){var e=l(this),t=e.data("addfield");t||e.data("addfield",t=new n(this)),"string"==typeof i&&t[i].call(e)})},l.fn.removeField=function(i){return this.each(function(){var e=l(this),t=e.data("removefield");t||e.data("removefield",t=new o(this)),"string"==typeof i&&t[i].call(e)})},l.fn.moveUpField=function(i){return this.each(function(){var e=l(this),t=e.data("moveupfield");t||e.data("moveupfield",t=new d(this)),"string"==typeof i&&t[i].call(e)})},l.fn.moveDownField=function(i){return this.each(function(){var e=l(this),t=e.data("movedownfield");t||e.data("movedownfield",t=new a(this)),"string"==typeof i&&t[i].call(e)})},l.fn.addField.Constructor=n,l.fn.removeField.Constructor=o,l.fn.moveUpField.Constructor=d,l.fn.moveDownField.Constructor=a,l.fn.addField.noConflict=function(){return l.fn.addField=e,this},l.fn.removeField.noConflict=function(){return l.fn.removeField=p,this},l.fn.moveUpField.noConflict=function(){return l.fn.moveUpField=s,this},l.fn.moveDownField.noConflict=function(){return l.fn.moveDownField=u,this},l(document).on("click.addfield.data-api",t,n.prototype.addField),l(document).on("click.removefield.data-api",i,o.prototype.removeField),l(document).on("click.moveupfield.data-api",r,d.prototype.moveUpField),l(document).on("click.movedownfield.data-api",f,a.prototype.moveDownField),{init:function(e){e.each(function(e,t){v(l(t)),l(t).attr("data-initialized",1)})}}});